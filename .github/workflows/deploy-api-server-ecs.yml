name: Deploy API Server to ECS (Multi-Region)

on:
  push:
    branches: [main]
    paths:
      - 'apps/api-server/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-api-server-ecs.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ ëŒ€ìƒ í™˜ê²½'
        required: false
        type: choice
        default: Staging
        options: [Staging, Production]

permissions:
  contents: read
  id-token: write

# ë°°í¬ ë™ì‹œì„± ê·¸ë£¹ì€ ì†Œë¬¸ìž(=ì‹¤ì œ ëŸ°íƒ€ìž„ env)ë¡œ ê³ ì •
concurrency:
  group: api-server-ecs-${{ (github.event.inputs.environment == 'Production' && 'production') || (github.event.inputs.environment == 'Staging' && 'staging') || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/develop' && 'staging') || 'staging' }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'Production') || (github.ref == 'refs/heads/develop' && 'Staging') || 'Staging' }}

    env:
      DEPLOY_ENV: ${{ (github.event.inputs.environment == 'Production' && 'production') || (github.event.inputs.environment == 'Staging' && 'staging') || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/develop' && 'staging') || 'staging' }}
      DOCKER_BUILDKIT: 1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ secrets.API_ECR_REPOSITORY }}

    outputs:
      image-tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Prisma environment file
        run: |
          # ë”ë¯¸ URL ì‚¬ìš© (prisma generateëŠ” ì‹¤ì œ ì—°ê²° ì•ˆ í•¨)
          # ì‹¤ì œ DB ì—°ê²°ì€ ëŸ°íƒ€ìž„ì— ECS íƒœìŠ¤í¬ ì •ì˜ì˜ secretsì—ì„œ ê´€ë¦¬ë¨
          bash scripts/deploy/api-server-ecs/prepare-prisma-env.sh \
            "" \
            ""

      - name: ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        id: meta
        shell: bash
        run: |
          sha_short="${GITHUB_SHA:0:7}"
          image_tag="${DEPLOY_ENV}-${sha_short}"
          echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
          echo "IMAGE_TAG=${image_tag}" >> "$GITHUB_ENV"

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          bash scripts/deploy/api-server-ecs/build-docker-image.sh "${IMAGE_TAG}"

      - name: Configure AWS credentials for image push
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.API_AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Push Docker image to ECR repositories
        run: |
          regions=("us-east-1" "eu-west-1")
          for region in "${regions[@]}"; do
            ecr_registry="${AWS_ACCOUNT_ID}.dkr.ecr.${region}.amazonaws.com"
            image_uri="${ecr_registry}/${ECR_REPOSITORY}:${IMAGE_TAG}"
            image_latest="${ecr_registry}/${ECR_REPOSITORY}:${DEPLOY_ENV}-latest"

            echo "ðŸ” Logging in to ECR ${region}"
            aws ecr get-login-password --region "${region}" | docker login --username AWS --password-stdin "${ecr_registry}"

            echo "ðŸ” Ensuring repository ${ECR_REPOSITORY} exists in ${region}"
            if ! aws ecr describe-repositories --repository-names "${ECR_REPOSITORY}" --region "${region}" >/dev/null 2>&1; then
              aws ecr create-repository \
                --repository-name "${ECR_REPOSITORY}" \
                --region "${region}" \
                --image-scanning-configuration scanOnPush=true \
                --encryption-configuration encryptionType=AES256
            fi

            echo "ðŸ·ï¸ Tagging image for ${region}"
            docker tag api-server:${IMAGE_TAG} "${image_uri}"
            docker tag api-server:${IMAGE_TAG} "${image_latest}"

            echo "ðŸš€ Pushing ${image_uri}"
            docker push "${image_uri}"
            echo "ðŸš€ Pushing ${image_latest}"
            docker push "${image_latest}"
          done

      - name: Clean up local images
        if: always()
        run: |
          docker image rm "api-server:${IMAGE_TAG}" || true

  deploy:
    name: Deploy to ECS (${{ matrix.region }})
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'Production') || (github.ref == 'refs/heads/develop' && 'Staging') || 'Staging' }}

    strategy:
      fail-fast: false
      matrix:
        region:
          - name: us-east-1
            display: 'ë¯¸êµ­ ë™ë¶€ (ë²„ì§€ë‹ˆì•„ ë¶ë¶€)'
          - name: eu-west-1
            display: 'ìœ ëŸ½ (ì•„ì¼ëžœë“œ)'

    env:
      DEPLOY_ENV: ${{ (github.event.inputs.environment == 'Production' && 'production') || (github.event.inputs.environment == 'Staging' && 'staging') || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/develop' && 'staging') || 'staging' }}
      AWS_REGION: ${{ matrix.region.name }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ secrets.API_ECR_REPOSITORY }}
      ECS_CONTAINER_NAME: api-server
      ECS_CLUSTER_US_EAST_1: ${{ secrets.API_ECS_CLUSTER_US_EAST_1 }}
      ECS_CLUSTER_EU_WEST_1: ${{ secrets.API_ECS_CLUSTER_EU_WEST_1 }}
      ECS_SERVICE_US_EAST_1: ${{ secrets.API_ECS_SERVICE_US_EAST_1 }}
      ECS_SERVICE_EU_WEST_1: ${{ secrets.API_ECS_SERVICE_EU_WEST_1 }}
      ECS_TASK_DEFINITION_US_EAST_1: ${{ secrets.API_ECS_TASK_DEFINITION_US_EAST_1 }}
      ECS_TASK_DEFINITION_EU_WEST_1: ${{ secrets.API_ECS_TASK_DEFINITION_EU_WEST_1 }}
      ECS_TASK_ROLE_ARN_US_EAST_1: ${{ secrets.API_ECS_TASK_ROLE_ARN_US_EAST_1 }}
      ECS_TASK_ROLE_ARN_EU_WEST_1: ${{ secrets.API_ECS_TASK_ROLE_ARN_EU_WEST_1 }}
      ECS_EXECUTION_ROLE_ARN_US_EAST_1: ${{ secrets.API_ECS_EXECUTION_ROLE_ARN_US_EAST_1 }}
      ECS_EXECUTION_ROLE_ARN_EU_WEST_1: ${{ secrets.API_ECS_EXECUTION_ROLE_ARN_EU_WEST_1 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ë°°í¬ í™˜ê²½ ê²€ì¦
        id: validate
        shell: bash
        run: |
          bash scripts/deploy/api-server-ecs/validate-deployment.sh \
            "${DEPLOY_ENV}" \
            "${AWS_REGION}" \
            "${ECS_CLUSTER_US_EAST_1}" \
            "${ECS_CLUSTER_EU_WEST_1}" \
            "${ECS_SERVICE_US_EAST_1}" \
            "${ECS_SERVICE_EU_WEST_1}" \
            "${ECS_TASK_DEFINITION_US_EAST_1}" \
            "${ECS_TASK_DEFINITION_EU_WEST_1}"

          if [[ -z "${AWS_ACCOUNT_ID}" ]]; then
            echo "AWS_ACCOUNT_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" >&2
            exit 1
          fi

      - name: Resolve region-specific IAM roles
        run: |
          case "${AWS_REGION}" in
            us-east-1)
              if [ -z "${ECS_TASK_ROLE_ARN_US_EAST_1}" ] || [ -z "${ECS_EXECUTION_ROLE_ARN_US_EAST_1}" ]; then
                echo "us-east-1 ì—­í•  ARNì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" >&2
                exit 1
              fi
              {
                echo "ECS_TASK_ROLE_ARN=${ECS_TASK_ROLE_ARN_US_EAST_1}"
                echo "ECS_EXECUTION_ROLE_ARN=${ECS_EXECUTION_ROLE_ARN_US_EAST_1}"
              } >> "$GITHUB_ENV"
              ;;
            eu-west-1)
              if [ -z "${ECS_TASK_ROLE_ARN_EU_WEST_1}" ] || [ -z "${ECS_EXECUTION_ROLE_ARN_EU_WEST_1}" ]; then
                echo "eu-west-1 ì—­í•  ARNì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" >&2
                exit 1
              fi
              {
                echo "ECS_TASK_ROLE_ARN=${ECS_TASK_ROLE_ARN_EU_WEST_1}"
                echo "ECS_EXECUTION_ROLE_ARN=${ECS_EXECUTION_ROLE_ARN_EU_WEST_1}"
              } >> "$GITHUB_ENV"
              ;;
            *)
              echo "ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¦¬ì „: ${AWS_REGION}" >&2
              exit 1
              ;;
          esac

      - name: Print resolved deployment context
        run: |
          echo "Branch: ${GITHUB_REF}"
          echo "Deploy env: ${DEPLOY_ENV}"
          echo "Region: ${AWS_REGION}"
          echo "ECS task definition: ${ECS_TASK_DEFINITION:-<unset>}"
          echo "ECS cluster: ${ECS_CLUSTER:-<unset>}"
          echo "ECS service: ${ECS_SERVICE:-<unset>}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.API_AWS_ROLE_ARN }}
          role-session-name: GitHubActions-DeployAPI-${{ github.run_id }}-${{ matrix.region.name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì„¤ì •
        run: |
          image_tag="${{ needs.build.outputs.image-tag }}"
          if [ -z "$image_tag" ]; then
            sha_short="${GITHUB_SHA:0:7}"
            image_tag="${DEPLOY_ENV}-${sha_short}"
          fi
          ecr_registry="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "IMAGE_TAG=${image_tag}" >> "$GITHUB_ENV"
          echo "IMAGE_URI=${ecr_registry}/${ECR_REPOSITORY}:${image_tag}" >> "$GITHUB_ENV"
          echo "IMAGE_LATEST=${ecr_registry}/${ECR_REPOSITORY}:${DEPLOY_ENV}-latest" >> "$GITHUB_ENV"
          echo "ECR_REGISTRY=${ecr_registry}" >> "$GITHUB_ENV"

      - name: ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ ë° ìƒì„±
        run: |
          echo "ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ ì¤‘: ${ECR_REPOSITORY}"
          if ! aws ecr describe-repositories --repository-names "${ECR_REPOSITORY}" --region "${AWS_REGION}" 2>/dev/null; then
            echo "ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
            aws ecr create-repository \
              --repository-name "${ECR_REPOSITORY}" \
              --region "${AWS_REGION}" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
          else
            echo "ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤."
          fi

      - name: ECS íƒœìŠ¤í¬ ì •ì˜ ë‹¤ìš´ë¡œë“œ
        id: task-def
        run: |
          bash scripts/deploy/api-server-ecs/download-task-definition.sh \
            "${ECS_TASK_DEFINITION}" \
            "${AWS_REGION}" \
            "task-definition.json"

      - name: íƒœìŠ¤í¬ ì •ì˜ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
        id: new-task-def
        run: |
          bash scripts/deploy/api-server-ecs/prepare-task-definition.sh \
            "${{ steps.task-def.outputs.task_def_exists }}" \
            "${ECS_TASK_DEFINITION}" \
            "${IMAGE_URI}" \
            "${ECS_CONTAINER_NAME}" \
            "${AWS_REGION}" \
            "task-definition.json" \
            "new-task-definition.json"

      - name: ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
        id: register-task
        run: |
          task_def_arn=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --region "${AWS_REGION}" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          if [[ -z "$task_def_arn" ]]; then
            echo "íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡ ì‹¤íŒ¨" >&2
            exit 1
          fi

          echo "ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ARN: ${task_def_arn}"
          echo "task_def_arn=${task_def_arn}" >> "$GITHUB_OUTPUT"
          echo "TASK_DEF_ARN=${task_def_arn}" >> "$GITHUB_ENV"

      - name: CloudWatch Logs ê·¸ë£¹ ìƒì„±
        run: |
          log_group="/ecs/${ECS_TASK_DEFINITION}"
          if ! aws logs describe-log-groups --log-group-name-prefix "$log_group" --region "${AWS_REGION}" --query "logGroups[?logGroupName=='$log_group']" --output text | grep -q "$log_group"; then
            echo "CloudWatch Logs ê·¸ë£¹ ìƒì„± ì¤‘: ${log_group}"
            aws logs create-log-group \
              --log-group-name "$log_group" \
              --region "${AWS_REGION}" || true
          else
            echo "CloudWatch Logs ê·¸ë£¹ì´ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤: ${log_group}"
          fi

      - name: ECS ì„œë¹„ìŠ¤ í™•ì¸ ë° ìƒì„±
        run: |
          service_exists=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --region "${AWS_REGION}" \
            --query 'services[0].status' \
            --output text 2>/dev/null || echo "INACTIVE")

          if [[ "$service_exists" == "INACTIVE" || "$service_exists" == "None" ]]; then
            echo "âš ï¸ ECS ì„œë¹„ìŠ¤ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
            echo "í´ëŸ¬ìŠ¤í„°: ${ECS_CLUSTER}"
            echo "ì„œë¹„ìŠ¤: ${ECS_SERVICE}"
            echo "íƒœìŠ¤í¬ ì •ì˜: ${TASK_DEF_ARN}"
            exit 1
          else
            echo "ECS ì„œë¹„ìŠ¤ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤: ${ECS_SERVICE}"
          fi

      - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
        run: |
          echo "ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "ë¦¬ì „: ${AWS_REGION} (${{ matrix.region.display }})"
          echo "í´ëŸ¬ìŠ¤í„°: ${ECS_CLUSTER}"
          echo "ì„œë¹„ìŠ¤: ${ECS_SERVICE}"
          echo "ìƒˆ íƒœìŠ¤í¬ ì •ì˜: ${TASK_DEF_ARN}"

          # í˜„ìž¬ ì„œë¹„ìŠ¤ì˜ PRIMARY ë°°í¬ íƒœìŠ¤í¬ ì •ì˜ í™•ì¸
          current_service=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --region "${AWS_REGION}" \
            --query 'services[0]' \
            --output json)

          current_task_def=$(echo "$current_service" | jq -r '.deployments[] | select(.status == "PRIMARY") | .taskDefinition // ""')
          echo "í˜„ìž¬ PRIMARY íƒœìŠ¤í¬ ì •ì˜: ${current_task_def}"

          # ì´ë¯¸ ê°™ì€ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë°°í¬ ì¤‘ì´ë©´ ìŠ¤í‚µ
          if [[ "$current_task_def" == "${TASK_DEF_ARN}" ]]; then
            echo "âš ï¸ ì´ë¯¸ ê°™ì€ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë°°í¬ ì¤‘ìž…ë‹ˆë‹¤. ìƒˆ ë°°í¬ë¥¼ ì‹œìž‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "í˜„ìž¬ ë°°í¬ ìƒíƒœ:"
            echo "$current_service" | jq '{runningCount, desiredCount, deployments: .deployments[] | {taskDefinition, status, runningCount, desiredCount}}'
            exit 0
          fi

          # ë°°í¬ ì„¤ì • í™•ì¸ (ë°°í¬ ì§„í–‰ ì¤‘ì´ë©´ ëŒ€ê¸°)
          active_deployments=$(echo "$current_service" | jq -r '[.deployments[] | select(.status == "PRIMARY" or .status == "ACTIVE")] | length')
          if [ "$active_deployments" -gt 1 ]; then
            echo "âš ï¸ ì´ë¯¸ ë°°í¬ê°€ ì§„í–‰ ì¤‘ìž…ë‹ˆë‹¤. ë°°í¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤..."
            # ê¸°ì¡´ ë°°í¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ë¡œì§ì€ ë°°í¬ ìƒíƒœ í™•ì¸ ë‹¨ê³„ì—ì„œ ì²˜ë¦¬ë¨
          fi

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --task-definition "${TASK_DEF_ARN}" \
            --region "${AWS_REGION}" \
            --force-new-deployment \
            --query 'service.serviceName' \
            --output text

          echo "ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ìš”ì²­ ì™„ë£Œ"

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          bash scripts/deploy/api-server-ecs/wait-for-deployment.sh \
            "${ECS_CLUSTER}" \
            "${ECS_SERVICE}" \
            "${TASK_DEF_ARN}" \
            "${AWS_REGION}" \
            60

  deploy-summary:
    name: ë°°í¬ ìš”ì•½
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ë°°í¬ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "## ë°°í¬ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë¦¬ì „ë³„ ë°°í¬ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ë¦¬ì „ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          # ê° ë¦¬ì „ì˜ ë°°í¬ ê²°ê³¼ í™•ì¸
          us_east_result="${{ needs.deploy.result }}"
          eu_west_result="${{ needs.deploy.result }}"

          # Matrix jobì˜ ê²°ê³¼ë¥¼ ê°œë³„ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ê²ƒì€ GitHub Actionsì˜ ì œí•œìœ¼ë¡œ ì¸í•´
          # deploy jobì˜ ì „ì²´ ê²°ê³¼ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
          if [[ "$us_east_result" == "success" ]] && [[ "$eu_west_result" == "success" ]]; then
            echo "| ë¯¸êµ­ ë™ë¶€ (ë²„ì§€ë‹ˆì•„ ë¶ë¶€) | âœ… ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
            echo "| ìœ ëŸ½ (ì•„ì¼ëžœë“œ) | âœ… ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ë¯¸êµ­ ë™ë¶€ (ë²„ì§€ë‹ˆì•„ ë¶ë¶€) | âŒ ì‹¤íŒ¨ ë˜ëŠ” ì§„í–‰ ì¤‘ |" >> $GITHUB_STEP_SUMMARY
            echo "| ìœ ëŸ½ (ì•„ì¼ëžœë“œ) | âŒ ì‹¤íŒ¨ ë˜ëŠ” ì§„í–‰ ì¤‘ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìƒì„¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- ë°°í¬ í™˜ê²½: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'Production') || (github.ref == 'refs/heads/develop' && 'Staging') || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ì»¤ë°‹: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- ë¸Œëžœì¹˜: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
